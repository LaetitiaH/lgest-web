<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="../node_modules/vue/dist/vue.min.js" type="text/javascript"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <link rel="stylesheet" href="../node_modules/bulma/css/bulma.min.css">

    <title>Liste des soci√©t√©s</title>
</head>

<body>

    <!-- Nav-bar -->

    <nav class="navbar is-info" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item">
                <img src="../images/logo_small.png" width="112" height="28">
            </a>

            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false"
                data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>

        <div id="navbarBasicExample" class="navbar-menu">
            <div class="navbar-start">
                <a class="navbar-item">
                    Home
                </a>

                <a class="navbar-item">
                    Soci√©t√©s
                </a>
            </div>
        </div>

        <div class="navbar-end">
            <div class="navbar-item">
                <div class="buttons">
                    <a class="button is-light">
                        Log in
                    </a>
                </div>
            </div>
        </div>
    </nav>


    <!-- Fin Nav-bar -->

    <!-- Liste des soci√©t√©s -->
    <div class="columns">
        <div class="column is-four-fifths">
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title is-centered">
                        Liste des soci√©t√©s
                    </p>
                </header>

                <div id="app">
                    <div class="card-content">
                        <div class="content">
                            <p v-if="error">{{ error }}</p>
                            <p v-else-if="societes.length === 0">Aucune soci√©t√©</p>
                            <table class="table is-hoverable" id="societesTable" v-else>
                                <thead>
                                    <tr>
                                        <td>ID</td>
                                        <td>Label</td>
                                        <td></td>
                                    </tr>
                                </thead>
                                <tr v-for="societe in societes">
                                    <td>{{ societe.id }}</td>
                                    <td>{{ societe.label }}</td>
                                    <td><a class="delete" v-on:click="deleteSociete(societe)"></a>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fin liste des soci√©t√©s -->

        <!-- Formulaire Ajout soci√©t√© -->
        <div class="column">
            <div class="field">
                <form id="form">
                    <div>
                        <label for="label" class="label">Label</label>

                        <div class="control">
                            <input type="text" id="label" name="label" class="input" placeholder="Text input">
                        </div>
                    </div>
            </div>
            <button type="submit" color="primary">Ajouter la soci√©t√©</button>
            </form>

        </div>
    </div>
    </div>

    <script>
        let vm;

        window.addEventListener('load', () => {

            vm = new Vue({ // eslint-disable-line no-undef
                el: '#app',
                data: {
                    societes: [],
                    error: ''
                }
            });

            // API Call

            loadSocietes();

            // API POST Call
            document.getElementById('form').addEventListener('submit', (event) => {
                event.preventDefault();
                const label = document.getElementById('label').value;
                fetch('http://localhost:3000/societes', {
                    method: 'POST',
                    headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ label: label }),
                })
                    .then(loadSocietes)
                    .then(document.getElementById('form').reset());
            });
        });

        function loadSocietes() {
            fetch('http://localhost:3000/societes')
                // transmet le body de la r√©ponse sur le then suivant
                .catch(() => { vm.error = 'Une erreur inattendue est arriv√©e üò§'; })
                .then(societesResponse => societesResponse.json())
                .then(societes => (vm.societes = societes));
        };

        // API DELETE CALL
        function deleteSociete(societe) { // eslint-disable-line no-unused-vars
            fetch('http://localhost:3000/societes/' + societe.id, {
                method: 'delete'
            })
                .then(loadSocietes);
        }
    </script>

</body>

</html>
